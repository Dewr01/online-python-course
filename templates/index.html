<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Онлайн курс Python 3.12</title>
    <link rel="stylesheet" href="/static/style.css">
    <style>
        .theory-content {
            white-space: pre-wrap;
            line-height: 1.6;
            font-size: 16px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        .code-block {
            background: #2d2d2d;
            color: #f8f8f2;
            padding: 20px;
            border-radius: 8px;
            margin: 15px 0;
            overflow-x: auto;
            position: relative;
        }

        .language {
            position: absolute;
            top: 5px;
            right: 10px;
            background: #e74c3c;
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }

        .code-block pre {
            margin: 0;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 14px;
            line-height: 1.4;
        }

        .code-block code {
            font-family: inherit;
        }

        strong {
            font-weight: bold;
            color: #2c3e50;
        }

        em {
            font-style: italic;
        }

        code:not(.code-block code) {
            background: #f1f3f4;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 0.9em;
        }
    </style>
</head>
<body>
    <div id="app">
        <header class="app-header">
            <h1>Онлайн курс Python 3.12</h1>
            <span id="status" class="badge">Готов к работе</span>
        </header>

        <main class="app-main">
            <div class="navigation">
                <div class="modules-nav">
                    <h3>Модули курса</h3>
                    <div id="modules-list" class="modules-list">
                        {% for module in modules %}
                        <div class="module-item">
                            <div class="module-header" data-module-index="{{ loop.index0 }}">
                                <span class="module-title">{{ module.title }}</span>
                                <span class="module-arrow">▶</span>
                            </div>
                            <div class="module-topics" style="display: none;">
                                {% for topic in module.topics %}
                                <div class="topic-item">
                                    <span class="topic-title" 
                                          data-module-index="{{ loop.index0 }}" 
                                          data-topic-index="{{ loop.index0 }}"
                                          data-lesson-id="{{ topic.id }}">
                                        {{ topic.title }}
                                    </span>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <div class="lesson-content">
                <div class="lesson-header">
                    <h2 id="current-lesson-title">Выберите тему</h2>
                    <div class="lesson-controls">
                        <button id="show-theory" class="btn btn-primary">Показать теорию</button>
                        <button id="check-answers" class="btn btn-success" style="display: none;">Проверить ответы</button>
                    </div>
                </div>

                <section id="theory-content" class="box theory-section"></section>
                <section id="tasks-container" class="box tasks-section"></section>
                <section id="check-result" class="box result-section"></section>
            </div>
        </main>
    </div>

    <script>
        let currentLessonId = null;
        let currentLessonIndex = null;
        let userAttempts = {};

        // Инициализация
        document.addEventListener('DOMContentLoaded', function() {
            initNavigation();
            initEventListeners();
        });

        function initNavigation() {
            // Обработчики кликов по модулям
            document.querySelectorAll('.module-header').forEach(header => {
                header.addEventListener('click', function() {
                    const moduleIndex = parseInt(this.dataset.moduleIndex);
                    const topics = this.nextElementSibling;
                    const arrow = this.querySelector('.module-arrow');
                    
                    // Закрываем все модули
                    document.querySelectorAll('.module-topics').forEach(t => t.style.display = 'none');
                    document.querySelectorAll('.module-arrow').forEach(a => a.textContent = '▶');
                    
                    // Открываем текущий модуль
                    if (topics.style.display === 'none') {
                        topics.style.display = 'block';
                        arrow.textContent = '▼';
                    }
                });
            });

            // Обработчики кликов по темам
            document.querySelectorAll('.topic-title').forEach(topic => {
                topic.addEventListener('click', function() {
                    const lessonId = this.dataset.lessonId;
                    loadLesson(lessonId);
                });
            });
        }

        function initEventListeners() {
            document.getElementById('show-theory').addEventListener('click', showTheory);
            document.getElementById('check-answers').addEventListener('click', checkAllAnswers);
        }

        async function loadLesson(lessonId) {
            try {
                currentLessonId = lessonId;
                document.getElementById('current-lesson-title').textContent = 'Загрузка...';
                
                // Очищаем содержимое
                document.getElementById('tasks-container').innerHTML = '';
                document.getElementById('check-result').innerHTML = '';
                document.getElementById('theory-content').innerHTML = '';
                document.getElementById('check-answers').style.display = 'none';
                
                // Загружаем урок
                const response = await fetch(`/api/lessons/${lessonId}`);
                if (!response.ok) {
                    throw new Error('Урок не найден');
                }
                
                const lesson = await response.json();
                currentLessonIndex = lesson.id;
                
                // Обновляем заголовок
                document.getElementById('current-lesson-title').textContent = lesson.title;
                
                // Загружаем задания
                loadTasks(lesson.tasks);
                
            } catch (error) {
                console.error('Ошибка загрузки урока:', error);
                document.getElementById('current-lesson-title').textContent = 'Ошибка загрузки урока';
            }
        }

        function loadTasks(tasks) {
            const container = document.getElementById('tasks-container');
            container.innerHTML = '';
            
            if (!tasks || tasks.length === 0) {
                container.innerHTML = '<em>Нет заданий для этого урока.</em>';
                return;
            }
            
            tasks.forEach(task => {
                const row = document.createElement('div');
                row.className = 'task-row';
                row.innerHTML = `
                    <label class="task-label">${task.question}</label>
                    <div class="task-input-group">
                        <input class="task-input" type="text" data-task-id="${task.id}" placeholder="Ваш ответ" />
                        <button class="btn btn-sm btn-submit" data-task-id="${task.id}">Отправить</button>
                    </div>
                `;
                container.appendChild(row);
            });

            // Добавляем обработчики для кнопок "Отправить"
            document.querySelectorAll('.btn-submit').forEach(btn => {
                btn.addEventListener('click', async function() {
                    const taskId = this.dataset.taskId;
                    const input = this.previousElementSibling;
                    const answer = input.value.trim();
                    
                    if (!answer) {
                        alert('Пожалуйста, введите ответ');
                        return;
                    }

                    await checkAnswer(taskId, answer, input, this);
                });
            });
        }

        async function checkAnswer(taskId, answer, input, button) {
            try {
                const response = await fetch('/api/check-answer', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        task_id: taskId,
                        answer: answer
                    })
                });

                if (!response.ok) {
                    throw new Error('Ошибка проверки ответа');
                }

                const result = await response.json();
                
                if (result.correct) {
                    input.style.borderColor = '#10b981';
                    input.style.backgroundColor = '#d1fae5';
                    button.textContent = '✓';
                    button.disabled = true;
                    input.disabled = true;
                } else {
                    input.style.borderColor = '#ef4444';
                    input.style.backgroundColor = '#fee2e2';
                    button.textContent = `Попытка ${result.attempts}`;
                    
                    // Показываем кнопку "Проверить ответы" после 3 попыток
                    if (result.attempts >= 3) {
                        document.getElementById('check-answers').style.display = 'inline-block';
                    }
                }
            } catch (error) {
                console.error('Ошибка проверки:', error);
                alert('Ошибка проверки ответа');
            }
        }

        async function showTheory() {
            if (!currentLessonId) {
                alert('Сначала выберите урок');
                return;
            }

            try {
                const response = await fetch(`/api/lesson/${currentLessonId}/theory`);
                if (!response.ok) {
                    throw new Error('Ошибка загрузки теории');
                }
                
                const data = await response.json();
                document.getElementById('theory-content').innerHTML = 
                    `<div class="theory-content">${data.theory || '(Теория отсутствует)'}</div>`;
            } catch (error) {
                console.error('Ошибка загрузки теории:', error);
                document.getElementById('theory-content').innerHTML = 
                    '<div class="error">Ошибка загрузки теории</div>';
            }
        }

        async function checkAllAnswers() {
            if (!currentLessonId) {
                alert('Сначала выберите урок');
                return;
            }

            try {
                const response = await fetch(`/api/lesson/${currentLessonId}/tasks`);
                if (!response.ok) {
                    throw new Error('Ошибка загрузки заданий');
                }
                
                const data = await response.json();
                const tasks = data.tasks;
                
                // Собираем все ответы
                const inputs = document.querySelectorAll('.task-input');
                const answers = {};
                inputs.forEach(inp => {
                    const id = inp.dataset.taskId;
                    answers[id] = inp.value;
                });

                // Проверяем каждое задание
                let correctCount = 0;
                const results = [];
                
                for (const task of tasks) {
                    const userAnswer = answers[task.id] || '';
                    const correct = userAnswer.trim().toLowerCase() === task.answer.trim().toLowerCase();
                    if (correct) correctCount++;
                    
                    results.push({
                        id: task.id,
                        correct: correct,
                        expected: task.answer,
                        hint: task.hint,
                        given: userAnswer
                    });
                }

                // Отображаем результат
                displayResults(results, correctCount, tasks.length);
                
            } catch (error) {
                console.error('Ошибка проверки:', error);
                document.getElementById('check-result').innerHTML = 
                    '<div class="error">Ошибка проверки заданий</div>';
            }
        }

        function displayResults(results, correctCount, totalCount) {
            const resultBox = document.getElementById('check-result');
            resultBox.innerHTML = '';
            
            const ul = document.createElement('ul');
            results.forEach(r => {
                const li = document.createElement('li');
                li.textContent = `Задание ${r.id}: ` + 
                    (r.correct ? 'верно' : `неверно. Ожидалось: ${r.expected}. ${r.hint || ''}`);
                if (!r.correct) li.className = 'error';
                ul.appendChild(li);
            });
            
            const summary = document.createElement('div');
            summary.className = 'summary';
            summary.textContent = `Правильных: ${correctCount} из ${totalCount}`;
            
            resultBox.appendChild(summary);
            resultBox.appendChild(ul);
        }
    </script>
</body>
</html>
